<%
    # Extract common values
    uri = URI.parse(request.url)
    scheme = uri.scheme
    current_units = defined?(units) && units ? units : 'imperial'
    depth_unit = current_units == 'metric' ? 'm' : 'ft'
    distance_unit = current_units == 'metric' ? 'km' : 'mi'
%>

<!-- Search Form with Autocomplete -->
<form action="/" accept-charset="UTF-8" method="POST" class="w-full max-w-2xl mx-auto"
      x-data="{
          query: '',
          results: [],
          showResults: false,
          selectedIndex: -1,
          loading: false,
          debounceTimer: null,

          async search() {
              if (this.query.length < 2) {
                  this.results = [];
                  this.showResults = false;
                  return;
              }

              this.loading = true;
              try {
                  const response = await fetch('/api/stations/autocomplete?q=' + encodeURIComponent(this.query));
                  const data = await response.json();
                  this.results = data.results;
                  this.showResults = this.results.length > 0;
                  this.selectedIndex = -1;
              } catch (e) {
                  console.error('Autocomplete error:', e);
              }
              this.loading = false;
          },

          debounceSearch() {
              clearTimeout(this.debounceTimer);
              this.debounceTimer = setTimeout(() => this.search(), 150);
          },

          selectResult(result) {
              this.query = result.name;
              this.showResults = false;
              this.$nextTick(() => this.$refs.submitBtn.click());
          },

          handleKeydown(e) {
              if (!this.showResults) return;

              if (e.key === 'ArrowDown') {
                  e.preventDefault();
                  this.selectedIndex = Math.min(this.selectedIndex + 1, this.results.length - 1);
              } else if (e.key === 'ArrowUp') {
                  e.preventDefault();
                  this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
              } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
                  e.preventDefault();
                  this.selectResult(this.results[this.selectedIndex]);
              } else if (e.key === 'Escape') {
                  this.showResults = false;
              }
          }
      }"
      @click.away="showResults = false"
>
    <div class="search-wrapper relative">
        <!-- Main search input -->
        <div class="relative flex items-center">
            <!-- Compass icon -->
            <div class="absolute left-4 pointer-events-none">
                <svg class="compass-icon w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M14.5 9.5l-5 2 2 5 5-2-2-5z"/>
                </svg>
            </div>

            <input
                type="text"
                name="searchtext"
                id="searchtext"
                x-ref="searchInput"
                x-model="query"
                @input="debounceSearch()"
                @keydown="handleKeydown($event)"
                @focus="if (results.length > 0) showResults = true"
                class="search-input w-full pl-12 pr-28 py-4 md:py-5 bg-navy-800/80 border border-navy-700/50 rounded-2xl text-white placeholder-slate-500 text-lg focus:outline-none focus:border-ocean-500/50"
                placeholder="<%= defined?(placeholder) && placeholder != 'Station...' ? placeholder : 'Try \"Alcatraz Island\" or \"San Francisco\"' %>"
                autocomplete="off"
            />

            <!-- Loading indicator -->
            <div x-show="loading" x-cloak class="absolute right-32 pointer-events-none">
                <svg class="w-5 h-5 text-ocean-400 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- Units toggle -->
            <div class="absolute right-20 flex items-center">
                <select
                    name="units"
                    id="searchunits"
                    class="bg-transparent border-none text-sm text-slate-400 focus:outline-none focus:ring-0 cursor-pointer hover:text-slate-300 transition-colors"
                >
                    <option value="imperial" <%= 'selected' if current_units == 'imperial' %> class="bg-navy-800">ft/mi</option>
                    <option value="metric" <%= 'selected' if current_units == 'metric' %> class="bg-navy-800">m/km</option>
                </select>
            </div>

            <!-- Search button -->
            <button
                type="submit"
                x-ref="submitBtn"
                class="absolute right-2 px-4 py-2 md:py-2.5 bg-ocean-500 hover:bg-ocean-400 text-white font-medium rounded-xl transition-all duration-200 btn-primary"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </button>
        </div>

        <!-- Autocomplete dropdown -->
        <div
            x-show="showResults"
            x-cloak
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 -translate-y-2"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-2"
            class="absolute z-50 w-full mt-2 bg-navy-800 border border-navy-700 rounded-xl shadow-2xl overflow-hidden"
        >
            <ul class="py-2 max-h-80 overflow-y-auto">
                <template x-for="(result, index) in results" :key="index">
                    <li
                        @click="selectResult(result)"
                        @mouseenter="selectedIndex = index"
                        :class="{ 'bg-navy-700': selectedIndex === index }"
                        class="px-4 py-3 cursor-pointer hover:bg-navy-700 transition-colors flex items-center gap-3"
                    >
                        <!-- Type icon -->
                        <div :class="result.type === 'tide' ? 'text-ocean-400' : 'text-seafoam-400'" class="flex-shrink-0">
                            <template x-if="result.type === 'tide'">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.66 8L12 2.35 6.34 8A8.02 8.02 0 004 13.64c0 2 .78 4.11 2.34 5.67a7.99 7.99 0 0011.32 0c1.56-1.56 2.34-3.67 2.34-5.67 0-2.15-.86-4.2-2.34-5.64z"/>
                                </svg>
                            </template>
                            <template x-if="result.type === 'current'">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                </svg>
                            </template>
                        </div>

                        <!-- Station info -->
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium truncate" x-text="result.name"></p>
                            <p class="text-slate-500 text-sm truncate" x-text="result.region"></p>
                        </div>

                        <!-- Type badge -->
                        <span
                            :class="result.type === 'tide' ? 'bg-ocean-500/20 text-ocean-400' : 'bg-seafoam-500/20 text-seafoam-400'"
                            class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium capitalize"
                            x-text="result.type"
                        ></span>
                    </li>
                </template>
            </ul>
        </div>

        <!-- GPS format hint -->
        <p class="text-center text-slate-600 text-xs mt-3">
            GPS: decimal <code class="text-slate-500">37.8, -122.4</code> or degrees <code class="text-slate-500">37°48'N 122°24'W</code>
        </p>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var search = document.getElementById('searchtext');
    if (search) {
        search.focus();

        // Retain prior search value with Ctrl+E or Right Arrow
        search.addEventListener('keydown', function(e) {
            if ((e.ctrlKey && e.key === 'e') || e.key === 'ArrowRight') {
                if ((this.selectionStart === 0 && this.selectionEnd === 0 && !this.value) ||
                    (e.key === 'ArrowRight' && this.selectionStart === 0 && this.selectionEnd === 0)) {
                    e.preventDefault();
                    if (this.placeholder && !this.placeholder.startsWith('Try')) {
                        this.value = this.placeholder;
                        this.selectionStart = this.selectionEnd = this.value.length;
                    }
                }
            }
        });
    }

    // Sticky search on scroll (only when results are visible)
    var stickySearch = document.querySelector('.search-sticky');
    if (stickySearch) {
        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (!entry.isIntersecting) {
                    stickySearch.classList.add('scrolled');
                } else {
                    stickySearch.classList.remove('scrolled');
                }
            });
        }, { threshold: 0, rootMargin: '-80px 0px 0px 0px' });

        var heroSection = document.querySelector('.hero-marker');
        if (heroSection) {
            observer.observe(heroSection);
        }

        // Scroll to results section on page load when results are present
        var results = document.getElementById('results');
        if (results) {
            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Helper to format and display time, storing raw ISO for re-formatting
    function setTimeElement(el, isoTime) {
        if (!el) return;
        el.dataset.isoTime = isoTime;
        el.textContent = '@ ' + window.tzUtils.formatTime(isoTime);
    }

    // Re-render all times when timezone preference changes
    window.addEventListener('tz-changed', function() {
        document.querySelectorAll('.data-time[data-iso-time]').forEach(function(el) {
            el.textContent = '@ ' + window.tzUtils.formatTime(el.dataset.isoTime);
        });
    });

    // Load station data for all cards
    var stationCards = document.querySelectorAll('.station-card[data-station-type]');
    stationCards.forEach(function(card) {
        var type = card.dataset.stationType;
        var id = card.dataset.stationId;

        fetch('/api/stations/' + type + '/' + encodeURIComponent(id) + '/next')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var preview = card.querySelector('.data-preview-content');
                if (!preview) return;

                if (data.error || !data.events || data.events.length === 0) {
                    // Show N/A when no data available
                    preview.querySelectorAll('.data-time').forEach(function(el) {
                        el.textContent = 'N/A';
                    });
                    return;
                }

                if (type === 'tides') {
                    // Events are sorted by time from API
                    data.events.forEach(function(event, index) {
                        var slotClass = index === 0 ? '.data-tide-1' : '.data-tide-2';
                        var slot = preview.querySelector(slotClass);
                        if (!slot) return;

                        var labelEl = slot.querySelector('.data-label');
                        var timeEl = slot.querySelector('.data-time');
                        var highIcon = slot.querySelector('.data-icon-high');
                        var lowIcon = slot.querySelector('.data-icon-low');

                        if (labelEl) labelEl.textContent = event.type;
                        setTimeElement(timeEl, event.time);

                        // Show correct icon
                        if (event.type === 'High') {
                            if (highIcon) highIcon.classList.remove('hidden');
                            if (lowIcon) lowIcon.classList.add('hidden');
                        } else {
                            if (highIcon) highIcon.classList.add('hidden');
                            if (lowIcon) lowIcon.classList.remove('hidden');
                        }
                    });

                    // Show N/A for missing slots
                    if (data.events.length < 1) {
                        var slot1 = preview.querySelector('.data-tide-1 .data-time');
                        if (slot1) slot1.textContent = 'N/A';
                    }
                    if (data.events.length < 2) {
                        var slot2 = preview.querySelector('.data-tide-2 .data-time');
                        if (slot2) slot2.textContent = 'N/A';
                    }
                } else if (type === 'currents') {
                    var hasSlack = false;
                    var nextMaxCurrent = null;

                    data.events.forEach(function(event) {
                        if (event.type === 'Slack') {
                            hasSlack = true;
                            var slackEl = preview.querySelector('.data-slack .data-time');
                            setTimeElement(slackEl, event.time);
                        } else if (event.type === 'Flood' || event.type === 'Ebb') {
                            // Keep the first max current event (events are sorted by time from API)
                            if (!nextMaxCurrent) {
                                nextMaxCurrent = event;
                            }
                        }
                    });

                    // Update max current display
                    if (nextMaxCurrent) {
                        var maxEl = preview.querySelector('.data-max-current');
                        if (maxEl) {
                            var labelEl = maxEl.querySelector('.data-label');
                            var timeEl = maxEl.querySelector('.data-time');
                            if (labelEl) labelEl.textContent = nextMaxCurrent.type;
                            setTimeElement(timeEl, nextMaxCurrent.time);
                        }
                    } else {
                        var maxTimeEl = preview.querySelector('.data-max-current .data-time');
                        if (maxTimeEl) maxTimeEl.textContent = 'N/A';
                    }

                    // Show N/A for missing slack
                    if (!hasSlack) {
                        var slackEl = preview.querySelector('.data-slack .data-time');
                        if (slackEl) slackEl.textContent = 'N/A';
                    }
                }
            })
            .catch(function(err) {
                console.error('Failed to load station data:', err);
                // Show N/A on error
                var preview = card.querySelector('.data-preview-content');
                if (preview) {
                    preview.querySelectorAll('.data-time').forEach(function(el) {
                        el.textContent = 'N/A';
                    });
                }
            });
    });
});
</script>

<% if defined?(tide_results) && defined?(current_results) %>
<!-- Hero marker for sticky detection -->
<div class="hero-marker"></div>
</div></header>

<!-- Sticky Search Bar (appears when scrolling results) -->
<div class="search-sticky hidden md:block">
    <div class="max-w-2xl mx-auto px-4">
        <form action="/" accept-charset="UTF-8" method="POST" class="relative"
              x-data="{
                  query: '',
                  results: [],
                  showResults: false,
                  selectedIndex: -1,
                  loading: false,
                  debounceTimer: null,

                  async search() {
                      if (this.query.length < 2) {
                          this.results = [];
                          this.showResults = false;
                          return;
                      }
                      this.loading = true;
                      try {
                          const response = await fetch('/api/stations/autocomplete?q=' + encodeURIComponent(this.query));
                          const data = await response.json();
                          this.results = data.results;
                          this.showResults = this.results.length > 0;
                          this.selectedIndex = -1;
                      } catch (e) {
                          console.error('Autocomplete error:', e);
                      }
                      this.loading = false;
                  },

                  debounceSearch() {
                      clearTimeout(this.debounceTimer);
                      this.debounceTimer = setTimeout(() => this.search(), 150);
                  },

                  selectResult(result) {
                      this.query = result.name;
                      this.showResults = false;
                      this.$nextTick(() => this.$refs.stickySubmitBtn.click());
                  },

                  handleKeydown(e) {
                      if (!this.showResults) return;
                      if (e.key === 'ArrowDown') {
                          e.preventDefault();
                          this.selectedIndex = Math.min(this.selectedIndex + 1, this.results.length - 1);
                      } else if (e.key === 'ArrowUp') {
                          e.preventDefault();
                          this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                      } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
                          e.preventDefault();
                          this.selectResult(this.results[this.selectedIndex]);
                      } else if (e.key === 'Escape') {
                          this.showResults = false;
                      }
                  }
              }"
              @click.away="showResults = false"
        >
            <div class="relative flex items-center">
                <div class="absolute left-4 pointer-events-none">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <input
                    type="text"
                    name="searchtext"
                    x-model="query"
                    @input="debounceSearch()"
                    @keydown="handleKeydown($event)"
                    @focus="if (results.length > 0) showResults = true"
                    class="w-full pl-12 pr-36 py-3 bg-navy-800/90 border border-navy-700/50 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-ocean-500/50"
                    placeholder="Search stations..."
                    autocomplete="off"
                />
                <div class="absolute right-24 flex items-center">
                    <select
                        name="units"
                        class="bg-transparent border-none text-sm text-slate-400 focus:outline-none focus:ring-0 cursor-pointer hover:text-slate-300 transition-colors"
                    >
                        <option value="imperial" <%= 'selected' if current_units == 'imperial' %> class="bg-navy-800">ft/mi</option>
                        <option value="metric" <%= 'selected' if current_units == 'metric' %> class="bg-navy-800">m/km</option>
                    </select>
                </div>
                <button type="submit" x-ref="stickySubmitBtn" class="absolute right-2 px-4 py-1.5 bg-ocean-500 hover:bg-ocean-400 text-white font-medium rounded-lg transition-colors text-sm">
                    Search
                </button>
            </div>

            <!-- Autocomplete dropdown -->
            <div
                x-show="showResults"
                x-cloak
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 -translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                class="absolute z-50 w-full mt-2 bg-navy-800 border border-navy-700 rounded-xl shadow-2xl overflow-hidden"
            >
                <ul class="py-2 max-h-64 overflow-y-auto">
                    <template x-for="(result, index) in results" :key="index">
                        <li
                            @click="selectResult(result)"
                            @mouseenter="selectedIndex = index"
                            :class="{ 'bg-navy-700': selectedIndex === index }"
                            class="px-4 py-2.5 cursor-pointer hover:bg-navy-700 transition-colors flex items-center gap-3"
                        >
                            <div :class="result.type === 'tide' ? 'text-ocean-400' : 'text-seafoam-400'" class="flex-shrink-0">
                                <template x-if="result.type === 'tide'">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.66 8L12 2.35 6.34 8A8.02 8.02 0 004 13.64c0 2 .78 4.11 2.34 5.67a7.99 7.99 0 0011.32 0c1.56-1.56 2.34-3.67 2.34-5.67 0-2.15-.86-4.2-2.34-5.64z"/>
                                    </svg>
                                </template>
                                <template x-if="result.type === 'current'">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                                    </svg>
                                </template>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate" x-text="result.name"></p>
                                <p class="text-slate-500 text-xs truncate" x-text="result.region"></p>
                            </div>
                            <span
                                :class="result.type === 'tide' ? 'bg-ocean-500/20 text-ocean-400' : 'bg-seafoam-500/20 text-seafoam-400'"
                                class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium capitalize"
                                x-text="result.type"
                            ></span>
                        </li>
                    </template>
                </ul>
            </div>
        </form>
    </div>
</div>

<!-- Results Section -->
<main id="results" class="bg-navy-950 pt-6 md:pt-8 pb-12 md:pb-16 scroll-mt-20">
    <div class="max-w-6xl mx-auto px-4">

        <!-- Search summary + Timezone toggle -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-6 mb-10 animate-fade-up">
            <p class="text-slate-400">
                <% case how
                   when 'by' %>
                    Showing results for "<span class="text-white font-medium"><%= tokens.join(" ") %></span>"
                <% when 'near' %>
                    Stations near <span class="text-white font-medium"><%= tokens.join(", ") %></span>
                <% end %>
                <% if radius && radius > 0 %>
                    within <span class="text-ocean-400"><%= radius %><%= distance_unit %></span>
                <% end %>
                <span class="text-slate-600">·</span>
                <span class="text-slate-500"><%= tide_results.count + current_results.count %> found</span>
            </p>

            <!-- Timezone Toggle -->
            <div x-data="timezoneToggle()" class="flex items-center gap-2 px-3 py-1.5 bg-navy-800/80 border border-navy-700/50 rounded-full">
                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-slate-400 text-sm">Times in</span>
                <button
                    @click="toggle()"
                    class="flex items-center gap-1 px-2 py-0.5 rounded text-sm font-medium transition-colors"
                    :class="useUTC ? 'bg-navy-600 text-slate-200' : 'bg-ocean-600/30 text-ocean-400'"
                >
                    <span x-text="useUTC ? 'UTC' : tzAbbrev"></span>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/>
                    </svg>
                </button>
            </div>
        </div>

        <% if tide_results.count > 0 %>
        <!-- Tide Stations Section -->
        <section class="mb-16 animate-fade-up animation-delay-100">
            <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-ocean-500/10 border border-ocean-500/20">
                    <svg class="w-5 h-5 text-ocean-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.66 8L12 2.35 6.34 8A8.02 8.02 0 004 13.64c0 2 .78 4.11 2.34 5.67a7.99 7.99 0 0011.32 0c1.56-1.56 2.34-3.67 2.34-5.67 0-2.15-.86-4.2-2.34-5.64zM6 14c.01-2 .62-3.27 1.76-4.4L12 5.27l4.24 4.38C17.38 10.77 17.99 12 18 14H6z"/>
                    </svg>
                </div>
                <h2 class="text-2xl md:text-3xl font-semibold text-white">Tide Stations</h2>
                <span class="text-slate-500 text-sm">(<%= tide_results.count %>)</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <% tide_results.each_with_index do |group, index| %>
                <%
                    r = group.primary  # Use primary station from group
                    has_alternatives = group.has_alternatives?
                    alternatives = group.alternatives || []
                    # Build base URL path only (no query string) - will be completed dynamically
                    uri.path = "/tides/"
                    uri.query = nil
                    uri.scheme = "webcal"
                    webcal_base = uri.to_s
                    uri.scheme = scheme
                    https_base = uri.to_s
                    card_id = "tide_#{r.id}"
                    # Build sources array for all cards (needed for dynamic URLs)
                    sources_json = ([r] + alternatives).map { |s|
                        { id: s.id, provider: s.provider.upcase }
                    }.to_json
                    # Google Maps Static API URL
                    map_url = "https://maps.googleapis.com/maps/api/staticmap?center=#{r.lat},#{r.lon}&zoom=11&size=200x200&scale=2&maptype=terrain&style=feature:water|color:0x0ea5e9&style=feature:landscape|color:0x1e293b&style=feature:road|visibility:off&style=feature:poi|visibility:off&style=feature:transit|visibility:off&style=element:labels|visibility:off&markers=color:0x0ea5e9|#{r.lat},#{r.lon}&key=#{ENV['GOOGLE_MAPS_API_KEY'] || 'YOUR_API_KEY'}"
                %>
                <div class="station-card swipe-container bg-navy-800/50 border border-navy-700/50 rounded-2xl overflow-hidden backdrop-blur-sm"
                     data-station-type="tides"
                     data-station-id="<%= r.id %>"
                     x-data="{
                         solar: true, lunar: false, mapLoaded: false, copied: false,
                         swipeX: 0, swiping: false, startX: 0,
                         selectedSource: '<%= r.id %>',
                         sources: <%= ERB::Util.html_escape(sources_json) %>,
                         webcalBase: '<%= webcal_base %>',
                         httpsBase: '<%= https_base %>',
                         units: '<%= current_units %>',
                         stationType: 'tides',
                         get currentSource() {
                             return this.sources.find(s => s.id === this.selectedSource) || this.sources[0];
                         },
                         getWebcalUrl() {
                             return this.webcalBase + this.selectedSource + '.ics?units=' + this.units + (!this.solar ? '&solar=0' : '') + (this.lunar ? '&lunar=1' : '');
                         },
                         getHttpsUrl() {
                             return this.httpsBase + this.selectedSource + '.ics?units=' + this.units + (!this.solar ? '&solar=0' : '') + (this.lunar ? '&lunar=1' : '');
                         },
                         loadNextEvents() {
                             const preview = this.$el.querySelector('.data-preview-content');
                             if (!preview) return;
                             fetch('/api/stations/' + this.stationType + '/' + encodeURIComponent(this.selectedSource) + '/next')
                                 .then(res => res.json())
                                 .then(data => {
                                     if (data.error || !data.events || data.events.length === 0) {
                                         preview.querySelectorAll('.data-time').forEach(el => { el.textContent = 'N/A'; });
                                         return;
                                     }
                                     data.events.forEach((event, index) => {
                                         const slotClass = index === 0 ? '.data-tide-1' : '.data-tide-2';
                                         const slot = preview.querySelector(slotClass);
                                         if (!slot) return;
                                         const labelEl = slot.querySelector('.data-label');
                                         const timeEl = slot.querySelector('.data-time');
                                         const highIcon = slot.querySelector('.data-icon-high');
                                         const lowIcon = slot.querySelector('.data-icon-low');
                                         if (labelEl) labelEl.textContent = event.type;
                                         if (timeEl) {
                                             timeEl.dataset.isoTime = event.time;
                                             timeEl.textContent = '@ ' + window.tzUtils.formatTime(event.time);
                                         }
                                         if (event.type === 'High') {
                                             if (highIcon) highIcon.classList.remove('hidden');
                                             if (lowIcon) lowIcon.classList.add('hidden');
                                         } else {
                                             if (highIcon) highIcon.classList.add('hidden');
                                             if (lowIcon) lowIcon.classList.remove('hidden');
                                         }
                                     });
                                 })
                                 .catch(err => {
                                     console.error('Failed to load station data:', err);
                                     preview.querySelectorAll('.data-time').forEach(el => { el.textContent = 'N/A'; });
                                 });
                         },
                         handleTouchStart(e) { this.startX = e.touches[0].clientX; this.swiping = true; },
                         handleTouchMove(e) { if (!this.swiping) return; const diff = this.startX - e.touches[0].clientX; this.swipeX = Math.max(0, Math.min(120, diff)); },
                         handleTouchEnd() { this.swiping = false; this.swipeX = this.swipeX > 60 ? 120 : 0; },
                         resetSwipe() { this.swipeX = 0; },
                         copyUrl(url) { navigator.clipboard.writeText(url); this.copied = true; setTimeout(() => this.copied = false, 1500); }
                     }"
                     @click.away="resetSwipe()"
                     @source-selected="selectedSource = $event.detail; loadNextEvents()"
                     style="animation-delay: <%= index * 50 %>ms">
                    <!-- Swipe action (subscribe) - visible when swiped -->
                    <div class="swipe-action bg-ocean-500 rounded-r-2xl md:hidden">
                        <a :href="getWebcalUrl()" class="swipe-action-btn">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Subscribe
                        </a>
                    </div>
                    <!-- Swipeable content wrapper -->
                    <div class="swipe-content" :class="{ 'swiping': swiping }" :style="'transform: translateX(-' + swipeX + 'px)'"
                         @touchstart="handleTouchStart($event)" @touchmove="handleTouchMove($event)" @touchend="handleTouchEnd()">

                    <!-- Card Header with Mini Map -->
                    <div class="p-3 md:p-4">
                        <div class="flex gap-4">
                            <!-- Mini Map Thumbnail -->
                            <div class="flex-shrink-0 w-20 h-20 md:w-24 md:h-24 rounded-xl overflow-hidden bg-navy-700/50 relative"
                                 x-intersect.once="mapLoaded = true">
                                <template x-if="mapLoaded">
                                    <img
                                        src="<%= map_url %>"
                                        alt="Map of <%= r.name %>"
                                        class="w-full h-full object-cover"
                                        loading="lazy"
                                    />
                                </template>
                                <template x-if="!mapLoaded">
                                    <div class="w-full h-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                        </svg>
                                    </div>
                                </template>
                                <!-- Map pin overlay -->
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="w-3 h-3 bg-ocean-500 rounded-full border-2 border-white shadow-lg"></div>
                                </div>
                            </div>

                            <!-- Station Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                    <h3 onmouseenter="stationTooltip.show(this, '<%= r.name.gsub("'", "\\\\'") %>')"
                                        class="text-lg md:text-xl font-semibold text-white truncate cursor-default">
                                        <%= r.name %>
                                    </h3>

                                    <!-- Provider badge with dropdown for alternatives -->
                                    <% if has_alternatives %>
                                    <div x-data="{
                                        showDropdown: false,
                                        showCompare: false,
                                        compareData: null,
                                        loading: false,
                                        provider: '<%= r.provider.upcase %>',
                                        sources: <%= ERB::Util.html_escape(sources_json) %>,
                                        localSelected: '<%= r.id %>',
                                        selectSource(id) {
                                            this.localSelected = id;
                                            const src = this.sources.find(s => s.id === id);
                                            if (src) this.provider = src.provider;
                                            this.$dispatch('source-selected', id);
                                            this.showDropdown = false;
                                        },
                                        async loadComparison() {
                                            if (this.compareData) return;
                                            this.loading = true;
                                            const ids = ['<%= r.id %>', <%= alternatives.map { |a| "'#{a.id}'" }.join(', ') %>];
                                            try {
                                                const response = await fetch('/api/stations/compare?type=tides&ids[]=' + ids.join('&ids[]='));
                                                this.compareData = await response.json();
                                            } catch (e) {
                                                console.error('Compare error:', e);
                                            }
                                            this.loading = false;
                                        }
                                    }"
                                    class="relative flex-shrink-0">
                                        <!-- Badge button - shows currently selected source -->
                                        <div class="flex items-center gap-1" x-data="{ showWarning: false }">
                                            <button
                                                @click="showDropdown = !showDropdown; if(showDropdown) loadComparison()"
                                                class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-colors border"
                                                :class="/noaa|chs/i.test(provider) ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30 hover:bg-emerald-500/30' : 'bg-amber-500/20 text-amber-400 border-amber-500/30 hover:bg-amber-500/30'"
                                            >
                                                <span x-text="provider"></span>
                                                <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': showDropdown }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </button>
                                            <!-- Warning icon for harmonic sources -->
                                            <template x-if="!/noaa|chs/i.test(provider)">
                                                <div class="relative">
                                                    <svg
                                                        @mouseenter="showWarning = true"
                                                        @mouseleave="showWarning = false"
                                                        @click="showWarning = !showWarning"
                                                        class="w-4 h-4 text-amber-400 cursor-help"
                                                        fill="currentColor" viewBox="0 0 24 24"
                                                    >
                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                                    </svg>
                                                    <div
                                                        x-show="showWarning"
                                                        x-cloak
                                                        x-transition
                                                        class="absolute top-full right-0 mt-2 w-64 p-3 bg-navy-900 border border-amber-500/30 rounded-lg shadow-xl z-50 text-xs"
                                                    >
                                                        <p class="font-bold text-amber-400 mb-1">NOT FOR NAVIGATION</p>
                                                        <p class="text-slate-400 leading-relaxed">Based on harmonic constants, not official measurements. Distributed WITHOUT ANY WARRANTY.</p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Dropdown menu -->
                                        <div
                                            x-show="showDropdown"
                                            x-cloak
                                            @click.away="showDropdown = false"
                                            x-transition
                                            class="absolute top-full right-0 mt-2 w-64 bg-navy-900 border border-navy-700 rounded-xl shadow-2xl z-50 overflow-hidden"
                                        >
                                            <!-- All sources - click to select -->
                                            <div class="py-1">
                                                <!-- Primary source -->
                                                <button
                                                    @click="selectSource('<%= r.id %>')"
                                                    class="w-full px-3 py-2 flex items-center justify-between hover:bg-navy-800 transition-colors text-left"
                                                    :class="localSelected === '<%= r.id %>' ? 'bg-navy-800/50' : ''"
                                                >
                                                    <div class="flex items-center gap-2">
                                                        <svg x-show="localSelected === '<%= r.id %>'" class="w-4 h-4 text-ocean-400" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                        </svg>
                                                        <span x-show="localSelected !== '<%= r.id %>'" class="w-4"></span>
                                                        <span class="text-white text-sm font-medium"><%= r.provider == 'ticon' ? 'TICON' : r.provider.upcase %></span>
                                                        <span class="text-slate-500 text-xs">(primary)</span>
                                                    </div>
                                                </button>

                                                <!-- Alternative sources -->
                                                <% alternatives.each do |alt| %>
                                                <button
                                                    @click="selectSource('<%= alt.id %>')"
                                                    class="w-full px-3 py-2 flex items-center justify-between hover:bg-navy-800 transition-colors text-left"
                                                    :class="localSelected === '<%= alt.id %>' ? 'bg-navy-800/50' : ''"
                                                >
                                                    <div class="flex items-center gap-2">
                                                        <svg x-show="localSelected === '<%= alt.id %>'" class="w-4 h-4 text-ocean-400" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                        </svg>
                                                        <span x-show="localSelected !== '<%= alt.id %>'" class="w-4"></span>
                                                        <span class="text-slate-300 text-sm"><%= alt.provider == 'ticon' ? 'TICON' : alt.provider.upcase %></span>
                                                    </div>
                                                    <div class="text-xs text-slate-500" x-show="compareData && compareData.stations">
                                                        <template x-if="compareData && compareData.stations">
                                                            <span x-text="(compareData.stations.find(s => s.id === '<%= alt.id %>') || {}).delta ? (compareData.stations.find(s => s.id === '<%= alt.id %>').delta.time + ', ' + (compareData.stations.find(s => s.id === '<%= alt.id %>').delta.height || '')) : ''"></span>
                                                        </template>
                                                    </div>
                                                    <div x-show="loading" class="text-slate-600 text-xs">...</div>
                                                </button>
                                                <% end %>
                                            </div>

                                            <!-- Compare link -->
                                            <div class="px-3 py-2 bg-navy-800/30 border-t border-navy-700">
                                                <button
                                                    @click="showCompare = true"
                                                    class="text-ocean-400 text-xs hover:text-ocean-300 transition-colors"
                                                >
                                                    Compare predictions →
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Comparison Popover (teleported to body to escape card overflow) -->
                                        <template x-teleport="body">
                                            <div
                                                x-show="showCompare"
                                                x-cloak
                                                x-transition
                                                class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50"
                                                @click.self="showCompare = false"
                                            >
                                                <div class="bg-navy-900 border border-navy-700 rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-hidden" @click.stop>
                                                    <!-- Popover header -->
                                                    <div class="flex items-center justify-between px-4 py-3 border-b border-navy-700">
                                                        <h4 class="text-lg font-semibold text-white">Compare Sources</h4>
                                                        <button @click="showCompare = false" class="text-slate-400 hover:text-white transition-colors">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                            </svg>
                                                        </button>
                                                    </div>

                                                <!-- Comparison table -->
                                                <div class="p-4 overflow-y-auto max-h-[60vh]">
                                                    <template x-if="loading">
                                                        <div class="text-center py-8">
                                                            <svg class="w-8 h-8 text-ocean-400 animate-spin mx-auto" fill="none" viewBox="0 0 24 24">
                                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                                            </svg>
                                                            <p class="text-slate-500 mt-2">Loading predictions...</p>
                                                        </div>
                                                    </template>

                                                    <template x-if="!loading && compareData && compareData.stations">
                                                        <div class="space-y-3">
                                                            <template x-for="(station, idx) in compareData.stations" :key="station.id">
                                                                <div class="p-3 rounded-xl" :class="idx === 0 ? 'bg-navy-800 border border-ocean-500/30' : (localSelected === station.id ? 'bg-ocean-900/30 border border-ocean-500/50' : 'bg-navy-800/50 border border-navy-700')">
                                                                    <div class="flex items-center justify-between mb-2">
                                                                        <div class="flex items-center gap-2">
                                                                            <span
                                                                                class="px-2 py-0.5 rounded text-xs font-medium"
                                                                                :class="station.provider.match(/noaa|chs/i) ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'"
                                                                                x-text="station.provider.toUpperCase()"
                                                                            ></span>
                                                                            <span x-show="idx === 0 && localSelected === station.id" class="text-xs text-slate-500">(primary)</span>
                                                                            <span x-show="localSelected === station.id && idx > 0" class="text-xs text-ocean-400">✓ selected</span>
                                                                        </div>
                                                                        <!-- Use button for alternatives -->
                                                                        <button
                                                                            x-show="localSelected !== station.id"
                                                                            @click="selectSource(station.id); showCompare = false"
                                                                            class="text-xs px-2 py-1 rounded bg-ocean-500/20 text-ocean-400 hover:bg-ocean-500/30 transition-colors"
                                                                        >
                                                                            Use this source
                                                                        </button>
                                                                    </div>

                                                                    <!-- Events with per-event deltas -->
                                                                    <div class="space-y-1">
                                                                        <template x-for="(event, eidx) in station.events.slice(0, 2)" :key="eidx">
                                                                            <div class="flex items-center justify-between text-sm">
                                                                                <span class="text-slate-400" x-text="event.type === 'H' ? 'High' : (event.type === 'L' ? 'Low' : event.type)"></span>
                                                                                <div class="flex items-center gap-2">
                                                                                    <span class="text-white" x-text="event.height ? (event.height.toFixed(1) + (event.units || 'ft')) : ''"></span>
                                                                                    <span class="text-slate-500" x-text="'@ ' + window.tzUtils.formatTime(event.time)"></span>
                                                                                    <!-- Per-event delta for alternatives -->
                                                                                    <template x-if="idx > 0 && station.event_deltas && station.event_deltas[eidx]">
                                                                                        <span class="text-ocean-400 text-xs" x-text="'(' + station.event_deltas[eidx].time + (station.event_deltas[eidx].value ? ', ' + station.event_deltas[eidx].value : '') + ')'"></span>
                                                                                    </template>
                                                                                </div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <template x-if="!loading && compareData && compareData.error">
                                                        <div class="text-center py-8 text-slate-500">
                                                            <p x-text="compareData.error"></p>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        </template>
                                    </div>
                                    <% elsif r.provider.in?(['xtide', 'ticon']) %>
                                    <div x-data="{ showTip: false }" class="relative flex-shrink-0">
                                        <span
                                            @mouseenter="showTip = true"
                                            @mouseleave="showTip = false"
                                            @click="showTip = !showTip"
                                            class="badge-warning inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-amber-500/20 text-amber-400 border border-amber-500/30 cursor-help"
                                        >
                                            <%= r.provider == 'ticon' ? 'TICON' : 'XTide' %>
                                        </span>
                                        <div
                                            x-show="showTip"
                                            x-cloak
                                            x-transition
                                            class="absolute top-full right-0 mt-2 w-64 p-3 bg-navy-900 border border-amber-500/30 rounded-lg shadow-xl z-50 text-xs"
                                        >
                                            <p class="font-bold text-amber-400 mb-1">NOT FOR NAVIGATION</p>
                                            <p class="text-slate-400 leading-relaxed">Based on harmonic constants, not official measurements. Distributed WITHOUT ANY WARRANTY.</p>
                                        </div>
                                    </div>
                                    <% elsif r.provider == 'noaa' %>
                                    <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                        NOAA
                                    </span>
                                    <% elsif r.provider == 'chs' %>
                                    <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                        CHS
                                    </span>
                                    <% end %>
                                </div>

                                <p class="text-slate-500 text-sm truncate mb-1"><%= r.region %></p>

                                <!-- Station ID (clickable for official sources) -->
                                <% if r.provider.in?(['xtide', 'ticon']) %>
                                <p class="text-slate-600 text-xs font-mono"><%= r.public_id %></p>
                                <% else %>
                                <a href="<%= r.url %>" target="_blank" class="text-ocean-400/70 hover:text-ocean-400 text-xs font-mono transition-colors">
                                    <%= r.public_id %> ↗
                                </a>
                                <% end %>
                            </div>
                        </div>
                    </div>

                    <!-- Data Preview Strip -->
                    <div class="px-2 md:px-3 py-2.5 bg-navy-900/30 border-t border-b border-navy-700/30 data-preview">
                        <div class="flex items-center gap-1.5 text-sm overflow-x-auto">
                            <span class="text-slate-500 flex-shrink-0">Next:</span>
                            <div class="flex items-center gap-1.5 text-slate-300 data-preview-content">
                                <span class="flex items-center gap-1 data-tide-1">
                                    <svg class="w-3.5 h-3.5 text-ocean-400 data-icon-high" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/>
                                    </svg>
                                    <svg class="w-3.5 h-3.5 text-slate-500 data-icon-low hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/>
                                    </svg>
                                    <span class="font-medium data-label">High</span>
                                    <span class="text-slate-400 data-time">@ --:--</span>
                                </span>
                                <span class="text-slate-600">·</span>
                                <span class="flex items-center gap-1 data-tide-2">
                                    <svg class="w-3.5 h-3.5 text-ocean-400 data-icon-high hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/>
                                    </svg>
                                    <svg class="w-3.5 h-3.5 text-slate-500 data-icon-low" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/>
                                    </svg>
                                    <span class="font-medium data-label">Low</span>
                                    <span class="text-slate-400 data-time">@ --:--</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Options & Actions -->
                    <div class="p-3 md:p-4">
                        <!-- Toggle options -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <div
                                        class="toggle-switch"
                                        :class="{ 'active': solar }"
                                        @click="solar = !solar"
                                    ></div>
                                    <span class="text-sm text-slate-400 group-hover:text-slate-300 transition-colors">
                                        <span class="hidden sm:inline">☀︎</span> Solar
                                    </span>
                                </label>

                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <div
                                        class="toggle-switch"
                                        :class="{ 'active': lunar }"
                                        @click="lunar = !lunar"
                                    ></div>
                                    <span class="text-sm text-slate-400 group-hover:text-slate-300 transition-colors">
                                        <span class="hidden sm:inline">☾</span> Lunar
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Action buttons -->
                        <div class="flex items-center gap-2">
                            <button
                                @click="copyUrl(getWebcalUrl())"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-navy-700/50 hover:bg-navy-700 border border-navy-600/50 rounded-xl text-sm text-slate-300 transition-all duration-200 btn-press"
                                :class="{ 'copy-success border-emerald-500/50 text-emerald-400': copied }"
                                title="Copy webcal URL"
                            >
                                <svg x-show="!copied" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                <svg x-show="copied" x-cloak class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span class="hidden sm:inline" x-text="copied ? 'Copied!' : 'Copy'">Copy</span>
                            </button>

                            <a
                                :href="getHttpsUrl()"
                                target="_blank"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-navy-700/50 hover:bg-navy-700 border border-navy-600/50 rounded-xl text-sm text-slate-300 transition-all duration-200 btn-press"
                                title="Download .ics file"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                <span class="hidden sm:inline">Download</span>
                            </a>

                            <a
                                :href="getWebcalUrl()"
                                class="flex-[1.5] flex items-center justify-center gap-2 px-4 py-2.5 bg-ocean-500 hover:bg-ocean-400 rounded-xl text-sm text-white font-medium transition-all duration-200 btn-primary btn-glow btn-press"
                                title="Subscribe in your calendar app"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Subscribe
                            </a>
                        </div>

                        <!-- Find nearby link -->
                        <div x-data="{ showNearby: false }" class="mt-3 relative">
                            <button
                                @click="showNearby = !showNearby"
                                class="text-xs text-slate-500 hover:text-ocean-400 transition-colors"
                            >
                                Find nearby stations →
                            </button>

                            <div
                                x-show="showNearby"
                                x-cloak
                                @click.away="showNearby = false"
                                x-transition
                                class="absolute left-0 bottom-full mb-2 p-3 bg-navy-900 border border-navy-700 rounded-xl shadow-xl z-50"
                            >
                                <form action="/" method="POST" class="flex items-center gap-2">
                                    <input type="hidden" name="searchtext" value="<%= r.id %>" />
                                    <input type="hidden" name="units" value="<%= current_units %>" />
                                    <input
                                        type="number"
                                        name="within"
                                        placeholder="10"
                                        class="w-16 px-2 py-1.5 bg-navy-800 border border-navy-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-ocean-500"
                                    />
                                    <span class="text-slate-500 text-sm"><%= distance_unit %></span>
                                    <button
                                        type="submit"
                                        class="px-3 py-1.5 bg-ocean-500 hover:bg-ocean-400 rounded-lg text-sm text-white transition-colors"
                                    >
                                        Search
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    </div><!-- close swipe-content -->
                </div>
                <% end %>
            </div>
        </section>
        <% end %>

        <% if current_results.count > 0 %>
        <!-- Current Stations Section -->
        <section class="animate-fade-up animation-delay-200">
            <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-seafoam-500/10 border border-seafoam-500/20">
                    <svg class="w-5 h-5 text-seafoam-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                </div>
                <h2 class="text-2xl md:text-3xl font-semibold text-white">Current Stations</h2>
                <span class="text-slate-500 text-sm">(<%= current_results.count %>)</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <% current_results.each_with_index do |group, index| %>
                <%
                    r = group.primary  # Use primary station from group
                    has_alternatives = group.has_alternatives?
                    alternatives = group.alternatives || []
                    # Build base URL path only (no query string) - will be completed dynamically
                    uri.path = "/currents/"
                    uri.query = nil
                    uri.scheme = "webcal"
                    webcal_base = uri.to_s
                    uri.scheme = scheme
                    https_base = uri.to_s
                    card_id = "current_#{r.bid}"
                    # Build sources array for all cards (needed for dynamic URLs)
                    sources_json = ([r] + alternatives).map { |s|
                        { id: s.bid, provider: s.provider.upcase }
                    }.to_json
                    # Google Maps Static API URL
                    map_url = "https://maps.googleapis.com/maps/api/staticmap?center=#{r.lat},#{r.lon}&zoom=11&size=200x200&scale=2&maptype=terrain&style=feature:water|color:0x2dd4bf&style=feature:landscape|color:0x1e293b&style=feature:road|visibility:off&style=feature:poi|visibility:off&style=feature:transit|visibility:off&style=element:labels|visibility:off&markers=color:0x2dd4bf|#{r.lat},#{r.lon}&key=#{ENV['GOOGLE_MAPS_API_KEY'] || 'YOUR_API_KEY'}"
                %>
                <div class="station-card swipe-container bg-navy-800/50 border border-navy-700/50 rounded-2xl overflow-hidden backdrop-blur-sm"
                     data-station-type="currents"
                     data-station-id="<%= r.bid %>"
                     x-data="{
                         solar: true, lunar: false, mapLoaded: false, copied: false,
                         swipeX: 0, swiping: false, startX: 0,
                         selectedSource: '<%= r.bid %>',
                         sources: <%= ERB::Util.html_escape(sources_json) %>,
                         webcalBase: '<%= webcal_base %>',
                         httpsBase: '<%= https_base %>',
                         units: '<%= current_units %>',
                         stationType: 'currents',
                         get currentSource() {
                             return this.sources.find(s => s.id === this.selectedSource) || this.sources[0];
                         },
                         getWebcalUrl() {
                             return this.webcalBase + this.selectedSource + '.ics?units=' + this.units + (!this.solar ? '&solar=0' : '') + (this.lunar ? '&lunar=1' : '');
                         },
                         getHttpsUrl() {
                             return this.httpsBase + this.selectedSource + '.ics?units=' + this.units + (!this.solar ? '&solar=0' : '') + (this.lunar ? '&lunar=1' : '');
                         },
                         loadNextEvents() {
                             const preview = this.$el.querySelector('.data-preview-content');
                             if (!preview) return;
                             fetch('/api/stations/' + this.stationType + '/' + encodeURIComponent(this.selectedSource) + '/next')
                                 .then(res => res.json())
                                 .then(data => {
                                     if (data.error || !data.events || data.events.length === 0) {
                                         preview.querySelectorAll('.data-time').forEach(el => { el.textContent = 'N/A'; });
                                         return;
                                     }
                                     let hasSlack = false;
                                     let nextMaxCurrent = null;
                                     data.events.forEach(event => {
                                         if (event.type === 'Slack') {
                                             hasSlack = true;
                                             const slackEl = preview.querySelector('.data-slack .data-time');
                                             if (slackEl) {
                                                 slackEl.dataset.isoTime = event.time;
                                                 slackEl.textContent = '@ ' + window.tzUtils.formatTime(event.time);
                                             }
                                         } else if ((event.type === 'Flood' || event.type === 'Ebb') && !nextMaxCurrent) {
                                             nextMaxCurrent = event;
                                         }
                                     });
                                     if (nextMaxCurrent) {
                                         const maxEl = preview.querySelector('.data-max-current');
                                         if (maxEl) {
                                             const labelEl = maxEl.querySelector('.data-label');
                                             const timeEl = maxEl.querySelector('.data-time');
                                             if (labelEl) labelEl.textContent = nextMaxCurrent.type;
                                             if (timeEl) {
                                                 timeEl.dataset.isoTime = nextMaxCurrent.time;
                                                 timeEl.textContent = '@ ' + window.tzUtils.formatTime(nextMaxCurrent.time);
                                             }
                                         }
                                     } else {
                                         const maxTimeEl = preview.querySelector('.data-max-current .data-time');
                                         if (maxTimeEl) maxTimeEl.textContent = 'N/A';
                                     }
                                     if (!hasSlack) {
                                         const slackEl = preview.querySelector('.data-slack .data-time');
                                         if (slackEl) slackEl.textContent = 'N/A';
                                     }
                                 })
                                 .catch(err => {
                                     console.error('Failed to load station data:', err);
                                     preview.querySelectorAll('.data-time').forEach(el => { el.textContent = 'N/A'; });
                                 });
                         },
                         handleTouchStart(e) { this.startX = e.touches[0].clientX; this.swiping = true; },
                         handleTouchMove(e) { if (!this.swiping) return; const diff = this.startX - e.touches[0].clientX; this.swipeX = Math.max(0, Math.min(120, diff)); },
                         handleTouchEnd() { this.swiping = false; this.swipeX = this.swipeX > 60 ? 120 : 0; },
                         resetSwipe() { this.swipeX = 0; },
                         copyUrl(url) { navigator.clipboard.writeText(url); this.copied = true; setTimeout(() => this.copied = false, 1500); }
                     }"
                     @click.away="resetSwipe()"
                     @source-selected="selectedSource = $event.detail; loadNextEvents()"
                     style="animation-delay: <%= index * 50 %>ms">
                    <!-- Swipe action (subscribe) - visible when swiped -->
                    <div class="swipe-action bg-seafoam-500 rounded-r-2xl md:hidden">
                        <a :href="getWebcalUrl()" class="swipe-action-btn text-navy-900">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Subscribe
                        </a>
                    </div>
                    <!-- Swipeable content wrapper -->
                    <div class="swipe-content" :class="{ 'swiping': swiping }" :style="'transform: translateX(-' + swipeX + 'px)'"
                         @touchstart="handleTouchStart($event)" @touchmove="handleTouchMove($event)" @touchend="handleTouchEnd()">

                    <!-- Card Header with Mini Map -->
                    <div class="p-3 md:p-4">
                        <div class="flex gap-4">
                            <!-- Mini Map Thumbnail -->
                            <div class="flex-shrink-0 w-20 h-20 md:w-24 md:h-24 rounded-xl overflow-hidden bg-navy-700/50 relative"
                                 x-intersect.once="mapLoaded = true">
                                <template x-if="mapLoaded">
                                    <img
                                        src="<%= map_url %>"
                                        alt="Map of <%= r.name %>"
                                        class="w-full h-full object-cover"
                                        loading="lazy"
                                    />
                                </template>
                                <template x-if="!mapLoaded">
                                    <div class="w-full h-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                        </svg>
                                    </div>
                                </template>
                                <!-- Map pin overlay -->
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="w-3 h-3 bg-seafoam-500 rounded-full border-2 border-white shadow-lg"></div>
                                </div>
                            </div>

                            <!-- Station Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                    <h3 onmouseenter="stationTooltip.show(this, '<%= r.name.gsub("'", "\\\\'") %>')"
                                        class="text-lg md:text-xl font-semibold text-white truncate cursor-default">
                                        <%= r.name %>
                                    </h3>

                                    <!-- Provider badge with dropdown for alternatives -->
                                    <% if has_alternatives %>
                                    <div x-data="{
                                        showDropdown: false,
                                        showCompare: false,
                                        compareData: null,
                                        loading: false,
                                        provider: '<%= r.provider.upcase %>',
                                        sources: <%= ERB::Util.html_escape(sources_json) %>,
                                        localSelected: '<%= r.bid %>',
                                        selectSource(id) {
                                            this.localSelected = id;
                                            const src = this.sources.find(s => s.id === id);
                                            if (src) this.provider = src.provider;
                                            this.$dispatch('source-selected', id);
                                            this.showDropdown = false;
                                        },
                                        async loadComparison() {
                                            if (this.compareData) return;
                                            this.loading = true;
                                            const ids = ['<%= r.bid %>', <%= alternatives.map { |a| "'#{a.bid}'" }.join(', ') %>];
                                            try {
                                                const response = await fetch('/api/stations/compare?type=currents&ids[]=' + ids.join('&ids[]='));
                                                this.compareData = await response.json();
                                            } catch (e) {
                                                console.error('Compare error:', e);
                                            }
                                            this.loading = false;
                                        }
                                    }"
                                    class="relative flex-shrink-0">
                                        <!-- Badge button - shows currently selected source -->
                                        <div class="flex items-center gap-1" x-data="{ showWarning: false }">
                                            <button
                                                @click="showDropdown = !showDropdown; if(showDropdown) loadComparison()"
                                                class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-colors border"
                                                :class="/noaa|chs/i.test(provider) ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30 hover:bg-emerald-500/30' : 'bg-amber-500/20 text-amber-400 border-amber-500/30 hover:bg-amber-500/30'"
                                            >
                                                <span x-text="provider"></span>
                                                <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': showDropdown }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </button>
                                            <!-- Warning icon for harmonic sources -->
                                            <template x-if="!/noaa|chs/i.test(provider)">
                                                <div class="relative">
                                                    <svg
                                                        @mouseenter="showWarning = true"
                                                        @mouseleave="showWarning = false"
                                                        @click="showWarning = !showWarning"
                                                        class="w-4 h-4 text-amber-400 cursor-help"
                                                        fill="currentColor" viewBox="0 0 24 24"
                                                    >
                                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                                    </svg>
                                                    <div
                                                        x-show="showWarning"
                                                        x-cloak
                                                        x-transition
                                                        class="absolute top-full right-0 mt-2 w-64 p-3 bg-navy-900 border border-amber-500/30 rounded-lg shadow-xl z-50 text-xs"
                                                    >
                                                        <p class="font-bold text-amber-400 mb-1">NOT FOR NAVIGATION</p>
                                                        <p class="text-slate-400 leading-relaxed">Based on harmonic constants, not official measurements. Distributed WITHOUT ANY WARRANTY.</p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Dropdown menu -->
                                        <div
                                            x-show="showDropdown"
                                            x-cloak
                                            @click.away="showDropdown = false"
                                            x-transition
                                            class="absolute top-full right-0 mt-2 w-64 bg-navy-900 border border-navy-700 rounded-xl shadow-2xl z-50 overflow-hidden"
                                        >
                                            <!-- All sources - click to select -->
                                            <div class="py-1">
                                                <!-- Primary source -->
                                                <button
                                                    @click="selectSource('<%= r.bid %>')"
                                                    class="w-full px-3 py-2 flex items-center justify-between hover:bg-navy-800 transition-colors text-left"
                                                    :class="localSelected === '<%= r.bid %>' ? 'bg-navy-800/50' : ''"
                                                >
                                                    <div class="flex items-center gap-2">
                                                        <svg x-show="localSelected === '<%= r.bid %>'" class="w-4 h-4 text-seafoam-400" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                        </svg>
                                                        <span x-show="localSelected !== '<%= r.bid %>'" class="w-4"></span>
                                                        <span class="text-white text-sm font-medium"><%= r.provider == 'ticon' ? 'TICON' : r.provider.upcase %></span>
                                                        <span class="text-slate-500 text-xs">(primary)</span>
                                                    </div>
                                                </button>

                                                <!-- Alternative sources -->
                                                <% alternatives.each do |alt| %>
                                                <button
                                                    @click="selectSource('<%= alt.bid %>')"
                                                    class="w-full px-3 py-2 flex items-center justify-between hover:bg-navy-800 transition-colors text-left"
                                                    :class="localSelected === '<%= alt.bid %>' ? 'bg-navy-800/50' : ''"
                                                >
                                                    <div class="flex items-center gap-2">
                                                        <svg x-show="localSelected === '<%= alt.bid %>'" class="w-4 h-4 text-seafoam-400" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                        </svg>
                                                        <span x-show="localSelected !== '<%= alt.bid %>'" class="w-4"></span>
                                                        <span class="text-slate-300 text-sm"><%= alt.provider == 'ticon' ? 'TICON' : alt.provider.upcase %></span>
                                                    </div>
                                                    <div class="text-xs text-slate-500" x-show="compareData && compareData.stations">
                                                        <template x-if="compareData && compareData.stations">
                                                            <span x-text="(compareData.stations.find(s => s.id === '<%= alt.bid %>') || {}).delta ? (compareData.stations.find(s => s.id === '<%= alt.bid %>').delta.time + ', ' + (compareData.stations.find(s => s.id === '<%= alt.bid %>').delta.velocity || '')) : ''"></span>
                                                        </template>
                                                    </div>
                                                    <div x-show="loading" class="text-slate-600 text-xs">...</div>
                                                </button>
                                                <% end %>
                                            </div>

                                            <!-- Compare link -->
                                            <div class="px-3 py-2 bg-navy-800/30 border-t border-navy-700">
                                                <button
                                                    @click="showCompare = true"
                                                    class="text-seafoam-400 text-xs hover:text-seafoam-300 transition-colors"
                                                >
                                                    Compare predictions →
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Comparison Popover (teleported to body to escape card overflow) -->
                                        <template x-teleport="body">
                                            <div
                                                x-show="showCompare"
                                                x-cloak
                                                x-transition
                                                class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50"
                                                @click.self="showCompare = false"
                                            >
                                                <div class="bg-navy-900 border border-navy-700 rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-hidden" @click.stop>
                                                    <!-- Popover header -->
                                                    <div class="flex items-center justify-between px-4 py-3 border-b border-navy-700">
                                                        <h4 class="text-lg font-semibold text-white">Compare Sources</h4>
                                                        <button @click="showCompare = false" class="text-slate-400 hover:text-white transition-colors">
                                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                            </svg>
                                                        </button>
                                                    </div>

                                                    <!-- Comparison table -->
                                                <div class="p-4 overflow-y-auto max-h-[60vh]">
                                                    <template x-if="loading">
                                                        <div class="text-center py-8">
                                                            <svg class="w-8 h-8 text-seafoam-400 animate-spin mx-auto" fill="none" viewBox="0 0 24 24">
                                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                                            </svg>
                                                            <p class="text-slate-500 mt-2">Loading predictions...</p>
                                                        </div>
                                                    </template>

                                                    <template x-if="!loading && compareData && compareData.stations">
                                                        <div class="space-y-3">
                                                            <template x-for="(station, idx) in compareData.stations" :key="station.id">
                                                                <div class="p-3 rounded-xl" :class="idx === 0 ? 'bg-navy-800 border border-seafoam-500/30' : (localSelected === station.id ? 'bg-seafoam-900/30 border border-seafoam-500/50' : 'bg-navy-800/50 border border-navy-700')">
                                                                    <div class="flex items-center justify-between mb-2">
                                                                        <div class="flex items-center gap-2">
                                                                            <span
                                                                                class="px-2 py-0.5 rounded text-xs font-medium"
                                                                                :class="station.provider.match(/noaa|chs/i) ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'"
                                                                                x-text="station.provider.toUpperCase()"
                                                                            ></span>
                                                                            <span x-show="idx === 0 && localSelected === station.id" class="text-xs text-slate-500">(primary)</span>
                                                                            <span x-show="localSelected === station.id && idx > 0" class="text-xs text-seafoam-400">✓ selected</span>
                                                                        </div>
                                                                        <!-- Use button for alternatives -->
                                                                        <button
                                                                            x-show="localSelected !== station.id"
                                                                            @click="selectSource(station.id); showCompare = false"
                                                                            class="text-xs px-2 py-1 rounded bg-seafoam-500/20 text-seafoam-400 hover:bg-seafoam-500/30 transition-colors"
                                                                        >
                                                                            Use this source
                                                                        </button>
                                                                    </div>

                                                                    <!-- Events with per-event deltas -->
                                                                    <div class="space-y-1">
                                                                        <template x-for="(event, eidx) in station.events.slice(0, 2)" :key="eidx">
                                                                            <div class="flex items-center justify-between text-sm">
                                                                                <span class="text-slate-400" x-text="event.type"></span>
                                                                                <div class="flex items-center gap-2">
                                                                                    <span class="text-white" x-text="event.velocity != null ? (event.velocity.toFixed(1) + (event.velocity_units || 'kn')) : ''"></span>
                                                                                    <span class="text-slate-500" x-text="'@ ' + window.tzUtils.formatTime(event.time)"></span>
                                                                                    <!-- Per-event delta for alternatives -->
                                                                                    <template x-if="idx > 0 && station.event_deltas && station.event_deltas[eidx]">
                                                                                        <span class="text-seafoam-400 text-xs" x-text="'(' + station.event_deltas[eidx].time + (station.event_deltas[eidx].value ? ', ' + station.event_deltas[eidx].value : '') + ')'"></span>
                                                                                    </template>
                                                                                </div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <template x-if="!loading && compareData && compareData.error">
                                                        <div class="text-center py-8 text-slate-500">
                                                            <p x-text="compareData.error"></p>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                        </template>
                                    </div>
                                    <% elsif r.provider.in?(['xtide', 'ticon']) %>
                                    <div x-data="{ showTip: false }" class="relative flex-shrink-0">
                                        <span
                                            @mouseenter="showTip = true"
                                            @mouseleave="showTip = false"
                                            @click="showTip = !showTip"
                                            class="badge-warning inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-amber-500/20 text-amber-400 border border-amber-500/30 cursor-help"
                                        >
                                            <%= r.provider == 'ticon' ? 'TICON' : 'XTide' %>
                                        </span>
                                        <div
                                            x-show="showTip"
                                            x-cloak
                                            x-transition
                                            class="absolute top-full right-0 mt-2 w-64 p-3 bg-navy-900 border border-amber-500/30 rounded-lg shadow-xl z-50 text-xs"
                                        >
                                            <p class="font-bold text-amber-400 mb-1">NOT FOR NAVIGATION</p>
                                            <p class="text-slate-400 leading-relaxed">Based on harmonic constants, not official measurements. Distributed WITHOUT ANY WARRANTY.</p>
                                        </div>
                                    </div>
                                    <% elsif r.provider == 'noaa' %>
                                    <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                        NOAA
                                    </span>
                                    <% elsif r.provider == 'chs' %>
                                    <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-medium bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                                        CHS
                                    </span>
                                    <% end %>
                                </div>

                                <p class="text-slate-500 text-sm truncate mb-1"><%= r.region %></p>

                                <!-- Depth indicator -->
                                <span class="inline-flex items-center px-2 py-0.5 rounded bg-navy-700/50 text-xs text-slate-400 mb-1">
                                    📍 Depth: <%= r.depth.to_i %><%= depth_unit %>
                                </span>

                                <!-- Station ID (clickable for official sources) -->
                                <% if r.provider.in?(['xtide', 'ticon']) %>
                                <p class="text-slate-600 text-xs font-mono"><%= r.bid || r.id %></p>
                                <% else %>
                                <a href="<%= r.url %>" target="_blank" class="text-ocean-400/70 hover:text-ocean-400 text-xs font-mono transition-colors block">
                                    <%= r.bid || r.id %> ↗
                                </a>
                                <% end %>
                            </div>
                        </div>
                    </div>

                    <!-- Data Preview Strip -->
                    <div class="px-2 md:px-3 py-2.5 bg-navy-900/30 border-t border-b border-navy-700/30 data-preview">
                        <div class="flex items-center gap-1.5 text-sm overflow-x-auto">
                            <span class="text-slate-500 flex-shrink-0">Next:</span>
                            <div class="flex items-center gap-1.5 text-slate-300 data-preview-content">
                                <span class="flex items-center gap-1 data-slack">
                                    <span class="font-medium text-seafoam-400">Slack</span>
                                    <span class="text-slate-400 data-time">@ --:--</span>
                                </span>
                                <span class="text-slate-600">·</span>
                                <span class="flex items-center gap-1 data-max-current">
                                    <span class="font-medium data-label">Max</span>
                                    <span class="text-slate-400 data-time">@ --:--</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Options & Actions -->
                    <div class="p-3 md:p-4">
                        <!-- Toggle options -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <div
                                        class="toggle-switch"
                                        :class="{ 'active': solar }"
                                        @click="solar = !solar"
                                    ></div>
                                    <span class="text-sm text-slate-400 group-hover:text-slate-300 transition-colors">
                                        <span class="hidden sm:inline">☀︎</span> Solar
                                    </span>
                                </label>

                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <div
                                        class="toggle-switch"
                                        :class="{ 'active': lunar }"
                                        @click="lunar = !lunar"
                                    ></div>
                                    <span class="text-sm text-slate-400 group-hover:text-slate-300 transition-colors">
                                        <span class="hidden sm:inline">☾</span> Lunar
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Action buttons -->
                        <div class="flex items-center gap-2">
                            <button
                                @click="copyUrl(getWebcalUrl())"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-navy-700/50 hover:bg-navy-700 border border-navy-600/50 rounded-xl text-sm text-slate-300 transition-all duration-200 btn-press"
                                :class="{ 'copy-success border-emerald-500/50 text-emerald-400': copied }"
                                title="Copy webcal URL"
                            >
                                <svg x-show="!copied" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                <svg x-show="copied" x-cloak class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span class="hidden sm:inline" x-text="copied ? 'Copied!' : 'Copy'">Copy</span>
                            </button>

                            <a
                                :href="getHttpsUrl()"
                                target="_blank"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-navy-700/50 hover:bg-navy-700 border border-navy-600/50 rounded-xl text-sm text-slate-300 transition-all duration-200 btn-press"
                                title="Download .ics file"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                <span class="hidden sm:inline">Download</span>
                            </a>

                            <a
                                :href="getWebcalUrl()"
                                class="flex-[1.5] flex items-center justify-center gap-2 px-4 py-2.5 bg-seafoam-500 hover:bg-seafoam-400 rounded-xl text-sm text-navy-900 font-medium transition-all duration-200 btn-primary btn-glow btn-press"
                                title="Subscribe in your calendar app"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Subscribe
                            </a>
                        </div>

                        <!-- Find nearby link -->
                        <div x-data="{ showNearby: false }" class="mt-3 relative">
                            <button
                                @click="showNearby = !showNearby"
                                class="text-xs text-slate-500 hover:text-seafoam-400 transition-colors"
                            >
                                Find nearby stations →
                            </button>

                            <div
                                x-show="showNearby"
                                x-cloak
                                @click.away="showNearby = false"
                                x-transition
                                class="absolute left-0 bottom-full mb-2 p-3 bg-navy-900 border border-navy-700 rounded-xl shadow-xl z-50"
                            >
                                <form action="/" method="POST" class="flex items-center gap-2">
                                    <input type="hidden" name="searchtext" value="<%= r.id %>" />
                                    <input type="hidden" name="units" value="<%= current_units %>" />
                                    <input
                                        type="number"
                                        name="within"
                                        placeholder="10"
                                        class="w-16 px-2 py-1.5 bg-navy-800 border border-navy-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-seafoam-500"
                                    />
                                    <span class="text-slate-500 text-sm"><%= distance_unit %></span>
                                    <button
                                        type="submit"
                                        class="px-3 py-1.5 bg-seafoam-500 hover:bg-seafoam-400 rounded-lg text-sm text-navy-900 transition-colors"
                                    >
                                        Search
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    </div><!-- close swipe-content -->
                </div>
                <% end %>
            </div>
        </section>
        <% end %>

        <% if tide_results.count == 0 && current_results.count == 0 %>
        <!-- No results -->
        <div class="text-center py-16 animate-fade-up">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-navy-800/50 mb-4">
                <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <h3 class="text-xl text-slate-400 mb-2">No stations found</h3>
            <p class="text-slate-500">Try a different search term or GPS coordinates</p>
        </div>
        <% end %>

    </div>
</main>

<!-- Dummy elements to close the header tags opened in layout -->
<header class="hidden"><div class="hidden">
<% end %>
