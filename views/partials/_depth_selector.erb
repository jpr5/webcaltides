<%#
  Depth Selector Partial

  Shows depth badge with dropdown for selecting between different depths at the same location.
  Only renders for current stations with multiple depths available.

  Locals:
    - type: :tide or :current (only renders for :current)
    - theme: Hash with :accent (color name)
    - station: Station object (has .depth)
    - has_multiple_depths: boolean
    - sources_json: JSON string of sources array with depth info
%>
<% if type == :current && defined?(has_multiple_depths) && has_multiple_depths %>
<div x-data="{
    showDropdown: false,
    sources: <%= ERB::Util.html_escape(sources_json) %>,
    metric: window.unitUtils.isMetric(),
    _currentDepth: <%= station.depth&.to_i || 0 %>,
    _currentProvider: '<%= station.provider.upcase %>',

    // Get parent card data helper
    getParentData() {
        const cardEl = this.$el.closest('.station-card');
        return cardEl ? Alpine.$data(cardEl) : null;
    },

    // Get current depth - syncs with parent card
    get currentDepth() {
        const parent = this.getParentData();
        return parent?.selectedDepth ?? this._currentDepth;
    },

    // Get current provider from parent card's selected source
    get currentProvider() {
        const parent = this.getParentData();
        if (parent?.selectedSource) {
            const source = this.sources.find(s => s.id === parent.selectedSource);
            return source?.provider || this._currentProvider;
        }
        return this._currentProvider;
    },

    // Get depths available for the currently selected provider
    get availableDepths() {
        // Get unique depths for current provider, sorted
        const depths = [...new Set(
            this.sources
                .filter(s => s.provider === this.currentProvider && s.depth != null)
                .map(s => s.depth)
        )].sort((a, b) => a - b);
        return depths;
    },

    // Check if we should show dropdown (more than one depth for current provider)
    get showSelector() {
        return this.availableDepths.length > 1;
    },

    // Format depth with units
    formatDepth(depthFt) {
        if (depthFt == null) return 'Surface';
        const value = this.metric ? Math.round(depthFt * 0.3048) : depthFt;
        const unit = this.metric ? 'm' : 'ft';
        return value + unit;
    },

    selectDepth(depth) {
        // Find the source matching current provider + selected depth
        const source = this.sources.find(s =>
            s.provider === this.currentProvider && s.depth === depth
        );
        if (source) {
            this.$dispatch('depth-selected', { id: source.id, depth: depth });
        }
        this.showDropdown = false;
    }
}"
@units-changed.window="metric = window.unitUtils.isMetric()"
class="relative flex-shrink-0"
x-show="showSelector"
x-cloak>
    <!-- Depth badge button -->
    <button
        @click="showDropdown = !showDropdown"
        class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium cursor-pointer transition-colors border bg-navy-700/50 text-slate-300 border-navy-600/50 hover:bg-navy-700"
    >
        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
        </svg>
        <span x-text="formatDepth(currentDepth)"></span>
        <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': showDropdown }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>

    <!-- Dropdown menu -->
    <div
        x-show="showDropdown"
        x-cloak
        @click.away="showDropdown = false"
        x-transition
        class="absolute top-full right-0 mt-2 min-w-[120px] bg-navy-900 border border-navy-700 rounded-xl shadow-2xl z-50 overflow-hidden"
    >
        <div class="py-1">
            <template x-for="depth in availableDepths" :key="depth">
                <button
                    @click="selectDepth(depth)"
                    class="w-full px-3 py-2 flex items-center justify-between hover:bg-navy-800 transition-colors text-left"
                    :class="currentDepth === depth ? 'bg-navy-800/50' : ''"
                >
                    <div class="flex items-center gap-2">
                        <svg x-show="currentDepth === depth" class="w-4 h-4 text-<%= theme[:accent] %>-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                        <span x-show="currentDepth !== depth" class="w-4"></span>
                        <span class="text-slate-300 text-sm" x-text="formatDepth(depth)"></span>
                    </div>
                </button>
            </template>
        </div>
    </div>
</div>
<% end %>
